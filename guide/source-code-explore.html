<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Dva 源码解析 | SEF框架</title>
    <meta name="description" content="SEF1/SEF2框架使用说明.">
    <meta name="generator" content="VuePress 1.3.0">
    
    
    <link rel="preload" href="/websiteTest/assets/css/0.styles.2851619e.css" as="style"><link rel="preload" href="/websiteTest/assets/js/app.ecceaa25.js" as="script"><link rel="preload" href="/websiteTest/assets/js/2.851851d3.js" as="script"><link rel="preload" href="/websiteTest/assets/js/18.1ffc641a.js" as="script"><link rel="prefetch" href="/websiteTest/assets/js/10.2b2a6f99.js"><link rel="prefetch" href="/websiteTest/assets/js/11.e2a4292c.js"><link rel="prefetch" href="/websiteTest/assets/js/12.2da23257.js"><link rel="prefetch" href="/websiteTest/assets/js/13.a1abb0ae.js"><link rel="prefetch" href="/websiteTest/assets/js/14.4eefdb3c.js"><link rel="prefetch" href="/websiteTest/assets/js/15.d5332cd2.js"><link rel="prefetch" href="/websiteTest/assets/js/16.e37710b5.js"><link rel="prefetch" href="/websiteTest/assets/js/17.c073297e.js"><link rel="prefetch" href="/websiteTest/assets/js/19.1ae67b9a.js"><link rel="prefetch" href="/websiteTest/assets/js/3.fc587bee.js"><link rel="prefetch" href="/websiteTest/assets/js/4.b0dd307f.js"><link rel="prefetch" href="/websiteTest/assets/js/5.54a0d41e.js"><link rel="prefetch" href="/websiteTest/assets/js/6.780a1252.js"><link rel="prefetch" href="/websiteTest/assets/js/7.d49e5b5e.js"><link rel="prefetch" href="/websiteTest/assets/js/8.9ab9190a.js"><link rel="prefetch" href="/websiteTest/assets/js/9.981241f0.js">
    <link rel="stylesheet" href="/websiteTest/assets/css/0.styles.2851619e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/websiteTest/" class="home-link router-link-active"><!----> <span class="site-name">SEF框架</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/websiteTest/demo/" class="nav-link">
  测试Demo
</a></div><div class="nav-item"><a href="/websiteTest/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="https://github.com/dvajs/dva/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  发布日志
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xukhxukh/websiteTest/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/websiteTest/demo/" class="nav-link">
  测试Demo
</a></div><div class="nav-item"><a href="/websiteTest/guide/" class="nav-link router-link-active">
  指南
</a></div><div class="nav-item"><a href="https://github.com/dvajs/dva/releases" target="_blank" rel="noopener noreferrer" class="nav-link external">
  发布日志
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/xukhxukh/websiteTest/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/websiteTest/guide/" class="sidebar-link">介绍-修改后</a></li><li><a href="/websiteTest/guide/getting-started.html" class="sidebar-link">快速上手</a></li><li><a href="/websiteTest/guide/examples-and-boilerplates.html" class="sidebar-link">例子和脚手架</a></li><li><a href="/websiteTest/guide/concepts.html" class="sidebar-link">Dva 概念</a></li><li><a href="/websiteTest/guide/introduce-class.html" class="sidebar-link">入门课</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>社区</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/websiteTest/guide/fig-show.html" class="sidebar-link">Dva 图解</a></li><li><a href="/websiteTest/guide/develop-complex-spa.html" class="sidebar-link">使用 Dva 开发复杂 SPA</a></li><li><a href="/websiteTest/guide/source-code-explore.html" class="active sidebar-link">Dva 源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#隐藏在-package-json-里的秘密" class="sidebar-link">隐藏在 package.json 里的秘密</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#src-index-js" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#寻找-dva" class="sidebar-link">寻找 “dva”</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#src-index-js-2" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#视图与数据-上" class="sidebar-link">视图与数据(上)</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#视图与数据-下" class="sidebar-link">视图与数据(下)</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#package-json" class="sidebar-link">package.json</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#src-index-js-3" class="sidebar-link">src/index.js</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#model-方法" class="sidebar-link">model 方法</a></li><li class="sidebar-sub-header"><a href="/websiteTest/guide/source-code-explore.html#start-方法" class="sidebar-link">start 方法</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dva-源码解析"><a href="#dva-源码解析" class="header-anchor">#</a> Dva 源码解析</h1> <blockquote><p>作者：杨光</p></blockquote> <h2 id="隐藏在-package-json-里的秘密"><a href="#隐藏在-package-json-里的秘密" class="header-anchor">#</a> 隐藏在 package.json 里的秘密</h2> <p>随便哪个 dva 的项目，只要敲入 npm start 就可以运行启动。之前敲了无数次我都没有在意，直到我准备研究源码的时候才意识到：<strong>在敲下这行命令的时候，到底发生了什么呢？</strong></p> <p>答案要去 package.json 里去寻找。</p> <blockquote><p>有位技术大牛曾经告诉过我：看源码之前，先去看 package.json 。看看项目的入口文件，翻翻它用了哪些依赖，对项目便有了大致的概念。</p></blockquote> <p>package.json 里是这么写的：</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;roadhog server&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>翻翻依赖，<code>&quot;roadhog&quot;: &quot;^0.5.2&quot;</code>。</p> <p>既然能在 devDependencies 找到，那么肯定也能在 <a href="https://www.npmjs.com/package/roadhog" target="_blank" rel="noopener noreferrer">npm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上找到。原来是个和 webpack 相似的库，而且作者看着有点眼熟...</p> <p>如果说 dva 是亲女儿，那 <a href="https://github.com/sorrycc/roadhog.git" target="_blank" rel="noopener noreferrer">roadhog<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 就是亲哥哥了，起的是 webpack 自动打包和热更替的作用。</p> <p>在 roadhog 的默认配置里有这么一条信息：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;entry&quot;</span><span class="token operator">:</span> <span class="token string">&quot;src/index.js&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>后转了一圈，启动的入口回到了 <code>src/index.js</code>。</p> <h2 id="src-index-js"><a href="#src-index-js" class="header-anchor">#</a> <code>src/index.js</code></h2> <p>在 <code>src/index.js</code> 里，dva 一共做了这么几件事：</p> <ol start="0"><li><p>从 'dva' 依赖中引入 dva ：<code>import dva from 'dva'</code>;</p></li> <li><p>通过函数生成一个 app 对象：<code>const app = dva()</code>;</p></li> <li><p>加载插件：<code>app.use({})</code>;</p></li> <li><p>注入 model：<code>app.model(require('./models/example'))</code>;</p></li> <li><p>添加路由：<code>app.router(require('./routes/indexAnother'))</code>;</p></li> <li><p>启动：app.start('#root');</p></li></ol> <p>在这 6 步当中，dva 完成了 <code>使用 React 解决 view 层</code>、<code>redux 管理 model</code>、<code>saga 解决异步</code>的主要功能。事实上在我查阅资料以及回忆用过的脚手架时，发现目前端框架之所以被称为“框架”也就是解决了这些事情。前端工程师至今所做的事情都是在 <strong>分离动态的 data 和静态的 view</strong> ，只不过侧重点和实现方式也不同。</p> <p>至今为止出了这么多框架，但是前端 MVX 的思想一直都没有改变。</p> <h1 id="dva"><a href="#dva" class="header-anchor">#</a> dva</h1> <h2 id="寻找-dva"><a href="#寻找-dva" class="header-anchor">#</a> 寻找 “dva”</h2> <p>既然 dva 是来自于 <code>dva</code>，那么 dva 是什么这个问题自然要去 dva 的<a href="https://github.com/dvajs/dva" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中寻找了。</p> <blockquote><p>剧透：dva 是个函数，返回一了个 app 的对象。</p></blockquote> <blockquote><p>剧透2：目前 dva 的源码核心部分包含两部分，<code>dva</code> 和 <code>dva-core</code>。前者用高阶组件 React-redux 实现了 view 层，后者是用 redux-saga 解决了 model 层。</p></blockquote> <p>老规矩，还是先翻 package.json 。</p> <p>引用依赖很好的说明了 dva 的功能：统一 view 层。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// dva 使用的依赖如下：</span>

    <span class="token property">&quot;babel-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 一个编译后文件引用的公共库，可以有效减少编译后的文件体积</span>
    <span class="token property">&quot;dva-core&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.1.0&quot;</span><span class="token punctuation">,</span> <span class="token comment">// dva 另一个核心，用于处理数据层</span>
    <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 用于提供全局函数的引用</span>
    <span class="token property">&quot;history&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.6.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// browserHistory 或者 hashHistory</span>
    <span class="token property">&quot;invariant&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 一个有趣的断言库</span>
    <span class="token property">&quot;isomorphic-fetch&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 方便请求异步的函数，dva 中的 fetch 来源</span>
    <span class="token property">&quot;react-async-component&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.0-beta.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 组件懒加载</span>
    <span class="token property">&quot;react-redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.5&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 提供了一个高阶组件，方便在各处调用 store</span>
    <span class="token property">&quot;react-router-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.1.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// router4，终于可以像写组件一样写 router 了</span>
    <span class="token property">&quot;react-router-redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5.0.0-alpha.6&quot;</span><span class="token punctuation">,</span><span class="token comment">// redux 的中间件，在 provider 里可以嵌套 router</span>
    <span class="token property">&quot;redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.2&quot;</span> <span class="token comment">// 提供了 store、dispatch、reducer </span>
	
</code></pre></div><p>不过 script 没有给太多有用的信息，因为 <code>ruban build</code> 中的 <code>ruban</code> 显然是个私人库(虽然在 tnpm 上可以查到但是也是私人库)。但根据惯例，应该是 dva 包下的 <code>index.js</code> 文件提供了对外调用：</p> <div class="language-js extra-class"><pre class="language-js"><code>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">&quot;__esModule&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  value<span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>default <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>connect <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-redux'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>connect<span class="token punctuation">;</span>
</code></pre></div><p>显然这个 <code>exports.default</code> 就是我们要找的 dva，但是源码中没有 <code>./lib</code> 文件夹。当然直接看也应该看不懂，因为一般都是使用 babel 的命令 <code>babel src -d libs</code> 进行编译后生成的，所以直接去看 <code>src/index.js</code> 文件。</p> <h2 id="src-index-js-2"><a href="#src-index-js-2" class="header-anchor">#</a> <code>src/index.js</code></h2> <p><code>src/index.js</code><a href="https://github.com/dvajs/dva/blob/master/packages/dva/src/index.js" target="_blank" rel="noopener noreferrer">在此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ：</p> <p>在这里，dva 做了三件比较重要的事情：</p> <ol><li>使用 call 给 dva-core 实例化的 app(这个时候还只有数据层) 的 start 方法增加了一些新功能（或者说，通过代理模式给 model 层增加了 view 层）。</li> <li>使用 react-redux 完成了 react 到 redux 的连接。</li> <li>添加了 redux 的中间件 react-redux-router，强化了 history 对象的功能。</li></ol> <h3 id="使用-call-方法实现代理模式"><a href="#使用-call-方法实现代理模式" class="header-anchor">#</a> 使用 call 方法实现代理模式</h3> <p>dva 中实现代理模式的方式如下：</p> <p><strong>1. 新建 function ，函数内实例化一个 app 对象。</strong> <strong>2. 新建变量指向该对象希望代理的方法， <code>oldStart = app.start</code>。</strong> <strong>3. 新建同名方法 start，在其中使用 call，指定 oldStart 的调用者为 app。</strong> <strong>4. 令 app.start = start，完成对 app 对象的 start 方法的代理。</strong></p> <p>上代码:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// ...初始化 route ，和添加 route 中间件的方法。</span>

  <span class="token comment">/**
   * 1. 新建 function ，函数内实例化一个 app 对象。
   * 
   */</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> createOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**
   * 2. 新建变量指向该对象希望代理的方法
   * 
   */</span>
  <span class="token keyword">const</span> oldAppStart <span class="token operator">=</span> app<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  <span class="token comment">/**
   * 4. 令 app.start = start，完成对 app 对象的 start 方法的代理。
   * @type {[type]}
   */</span>
  app<span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>

  <span class="token comment">// router 赋值</span>

  <span class="token comment">/**
   * 3.1 新建同名方法 start，
   * 
   */</span>
  <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">container</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 合法性检测代码</span>

    <span class="token comment">/**
     * 3.2 在其中使用 call，指定 oldStart 的调用者为 app。
     */</span>
    <span class="token function">oldAppStart</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 因为有 3.2 的执行才有现在的 store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">;</span>

	<span class="token comment">// 使用高阶组件创建视图</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>为什么不直接在 start 方式中 oldAppStart ?</p></blockquote> <ul><li>因为 dva-core 的 start 方法里有用到 this，不用 call 指定调用者为 app 的话，oldAppStart() 会找错对象。</li></ul> <blockquote><p>实现代理模式一定要用到 call 吗？</p></blockquote> <ul><li>不一定，看有没有 使用 this 或者代理的函数是不是箭头函数。从另一个角度来说，如果使用了 function 关键字又在内部使用了 this，那么一定要用 call/apply/bind 指定 this。</li></ul> <blockquote><p>前端还有那里会用到 call ？</p></blockquote> <ul><li>就实际开发来讲，因为已经使用了 es6 标准，基本和 this 没什么打交道的机会。使用 class 类型的组件中偶尔还会用到 this.xxx.bind(this)，stateless 组件就洗洗睡吧(因为压根没有 this)。如果实现代理，可以使用继承/反向继承的方法 —— 比如高阶组件。</li></ul> <h3 id="使用-react-redux-的高阶组件传递-store"><a href="#使用-react-redux-的高阶组件传递-store" class="header-anchor">#</a> 使用 react-redux 的高阶组件传递 store</h3> <p>经过 call 代理后的 start 方法的主要作用，便是使用 react-redux 的 provider 组件将数据与视图联系了起来，生成 React 元素呈现给使用者。</p> <p>不多说，上代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用 querySelector 获得 dom</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[app.start] container </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>container<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> not found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 其他代码</span>

<span class="token comment">// 实例化 store</span>
<span class="token function">oldAppStart</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">;</span>

<span class="token comment">// export _getProvider for HMR</span>
<span class="token comment">// ref: https://github.com/dvajs/dva/issues/469</span>
app<span class="token punctuation">.</span>_getProvider <span class="token operator">=</span> <span class="token function">getProvider</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// If has container, render; else, return react component</span>
<span class="token comment">// 如果有真实的 dom 对象就把 react 拍进去</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_router<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 热加载在这里</span>
  app<span class="token punctuation">.</span><span class="token function">_plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">'onHmr'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">render</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 否则就生成一个 react ，供外界调用</span>
  <span class="token keyword">return</span> <span class="token function">getProvider</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_router<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
  
 <span class="token comment">// 使用高阶组件包裹组件</span>
<span class="token keyword">function</span> <span class="token function">getProvider</span><span class="token punctuation">(</span><span class="token parameter">store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">extraProps</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token punctuation">{</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">{</span> app<span class="token punctuation">,</span> history<span class="token operator">:</span> app<span class="token punctuation">.</span>_history<span class="token punctuation">,</span> <span class="token operator">...</span>extraProps <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 真正的 react 在这里</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token punctuation">,</span> store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ReactDOM <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-dom'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// eslint-disable-line</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token function">getProvider</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> app<span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>React.createElement(getProvider(store, app, router)) 怎么理解？</p></blockquote> <ul><li>getProvider 实际上返回的不单纯是函数，而是一个无状态的 React 组件。从这个角度理解的话，ReactElement.createElement(string/ReactClass type,[object props],[children ...]) 是可以这么写的。</li></ul> <blockquote><p>怎么理解 React 的 stateless 组件和 class 组件？</p></blockquote> <ul><li>你猜猜？</li></ul> <div class="language- extra-class"><pre class="language-text"><code>JavaScript 并不存在 class 这个东西，即便是 es6 引入了以后经过 babel 编译也会转换成函数。因此直接使用无状态组件，省去了将 class 实例化再调用 render 函数的过程，有效的加快了渲染速度。

即便是 class 组件，React.createElement 最终调用的也是 render 函数。不过这个目前只是我的推论，没有代码证据的证明。
</code></pre></div><h4 id="react-redux-与-provider"><a href="#react-redux-与-provider" class="header-anchor">#</a> react-redux 与 provider</h4> <blockquote><p>provider 是个什么东西？</p></blockquote> <p>本质上是个高阶组件，也是代理模式的一种实践方式。接收 redux 生成的 store 做参数后，通过上下文 context 将 store 传递进被代理组件。在保留原组件的功能不变的同时，增加了 store 的 dispatch 等方法。</p> <blockquote><p>connect 是个什么东西？</p></blockquote> <p>connect 也是一个代理模式实现的高阶组件，为被代理的组件实现了从 context 中获得 store 的方法。</p> <blockquote><p>connect()(MyComponent) 时发生了什么？</p></blockquote> <p>只放关键部分代码，因为我也只看懂了关键部分(捂脸跑)：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> connectAdvanced <span class="token keyword">from</span> <span class="token string">'../components/connectAdvanced'</span> 
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  connectHOC <span class="token operator">=</span> connectAdvanced<span class="token punctuation">,</span>
<span class="token operator">...</span><span class="token punctuation">.</span> 其他初始值
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> <span class="token comment">// 0 号 connnect</span>
    mapStateToProps<span class="token punctuation">,</span>
    mapDispatchToProps<span class="token punctuation">,</span>
   	<span class="token operator">...</span> 其他初始值
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>其他逻辑
    <span class="token keyword">return</span> <span class="token function">connectHOC</span><span class="token punctuation">(</span>selectorFactory<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">//  1号 connect</span>
		<span class="token operator">...</span><span class="token punctuation">.</span> 默认参数
		selectorFactory 也是个默认参数
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 这是 connect 的本体，导出时即生成 connect 0</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// hoist-non-react-statics，会自动把所有绑定在对象上的非React方法都绑定到新的对象上</span>
<span class="token keyword">import</span> hoistStatics <span class="token keyword">from</span> <span class="token string">'hoist-non-react-statics'</span>
<span class="token comment">// 1号 connect 的本体</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">connectAdvanced</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 逻辑处理</span>

	<span class="token comment">// 1 号 connect 调用时生成 2 号 connect</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">wrapWithConnect</span><span class="token punctuation">(</span><span class="token parameter">WrappedComponent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token comment">// ... 逻辑处理</span>

	<span class="token comment">// 在函数内定义了一个可以拿到上下文对象中 store 的组件</span>
    <span class="token keyword">class</span> <span class="token class-name">Connect</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
      
      <span class="token function">getChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 上下文对象中获得 store</span>
        <span class="token keyword">const</span> subscription <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>propsMode <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscription
        <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>subscriptionKey<span class="token punctuation">]</span><span class="token operator">:</span> subscription <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">[</span>subscriptionKey<span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
		
		<span class="token comment">// 逻辑处理</span>

      <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		  	<span class="token comment">// 	最终生成了新的 react 元素，并添加了新属性</span>
          <span class="token keyword">return</span> <span class="token function">createElement</span><span class="token punctuation">(</span>WrappedComponent<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addExtraProps</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span>props<span class="token punctuation">)</span><span class="token punctuation">)</span>

      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 逻辑处理</span>
	
	<span class="token comment">// 最后用定义的 class 和 被代理的组件生成新的 react 组件</span>
    <span class="token keyword">return</span> <span class="token function">hoistStatics</span><span class="token punctuation">(</span>Connect<span class="token punctuation">,</span> WrappedComponent<span class="token punctuation">)</span>  <span class="token comment">// 2 号函数调用后生成的对象是组件</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre></div><p>结论：对于 connect()(MyComponent)</p> <ol><li>connect 调用时生成 0 号 connect</li> <li>connect()  0 号 connect 调用，返回 1 号 connect 的调用 <code>connectHOC()</code> ，生成 2 号 connect(也是个函数) 。</li> <li>connect()(MyComponent) 等价于 connect2(MyComponent)，返回值是一个新的组件</li></ol> <h3 id="redux-与-router"><a href="#redux-与-router" class="header-anchor">#</a> redux 与 router</h3> <p>redux 是状态管理的库，router 是(唯一)控制页面跳转的库。两者都很美好，但是不美好的是两者无法协同工作。换句话说，当路由变化以后，store 无法感知到。</p> <p>于是便有了 <code>react-router-redux</code>。</p> <p><code>react-router-redux</code> 是 redux 的一个中间件(中间件：JavaScript 代理模式的另一种实践 针对 dispatch 实现了方法的代理，在 dispatch action 的时候增加或者修改) ，主要作用是：</p> <blockquote><p>加强了React Router库中history这个实例，以允许将history中接受到的变化反应到state中去。</p></blockquote> <p><a href="https://github.com/reactjs/react-router-redux" target="_blank" rel="noopener noreferrer">github 在此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>从代码上讲，主要是监听了 history 的变化：</p> <p><code>history.listen(location =&gt; analyticsService.track(location.pathname))</code></p> <p>dva 在此基础上又进行了一层代理，把代理后的对象当作初始值传递给了 dva-core，方便其在 model 的
subscriptions 中监听 router 变化。</p> <p>看看 <code>index.js</code> 里 router 的实现：</p> <p>1.在 createOpts 中初始化了添加 react-router-redux 中间件的方法和其 reducer ，方便 dva-core 在创建 store 的时候直接调用。</p> <ol start="2"><li>使用 patchHistory 函数代理 history.linsten，增加了一个回调函数的做参数(也就是订阅)。</li></ol> <blockquote><p>subscriptions 的东西可以放在 dva-core 里再说，</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> createHashHistory <span class="token keyword">from</span> <span class="token string">'history/createHashHistory'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  routerMiddleware<span class="token punctuation">,</span>
  routerReducer <span class="token keyword">as</span> routing<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> core <span class="token keyword">from</span> <span class="token string">'dva-core'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> history <span class="token operator">=</span> opts<span class="token punctuation">.</span>history <span class="token operator">||</span> <span class="token function">createHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> createOpts <span class="token operator">=</span> <span class="token punctuation">{</span>
  	<span class="token comment">// 	初始化 react-router-redux 的 router</span>
    initialReducer<span class="token operator">:</span> <span class="token punctuation">{</span>
      routing<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// 初始化 react-router-redux 添加中间件的方法，放在所有中间件最前面</span>
    <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>middlewares<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token comment">// 使用代理模式为 history 对象增加新功能，并赋给 app</span>
    <span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      app<span class="token punctuation">.</span>_history <span class="token operator">=</span> <span class="token function">patchHistory</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> createOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> oldAppStart <span class="token operator">=</span> app<span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
      <span class="token function">isFunction</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[app.router] router should be function, but got </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">typeof</span> router<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>_router <span class="token operator">=</span> router<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token comment">// 使用代理模式扩展 history 对象的 listen 方法，添加了一个回调函数做参数并在路由变化是主动调用</span>
<span class="token keyword">function</span> <span class="token function">patchHistory</span><span class="token punctuation">(</span><span class="token parameter">history</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> oldListen <span class="token operator">=</span> history<span class="token punctuation">.</span>listen<span class="token punctuation">;</span>
  history<span class="token punctuation">.</span><span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>history<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">oldListen</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> history<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>剧透：redux 中创建 store 的方法为：</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// combineReducers 接收的参数是对象</span>
<span class="token comment">// 所以 initialReducer 的类型是对象</span>
<span class="token comment">// 作用：将对象中所有的 reducer 组合成一个大的 reducer</span>
<span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token comment">// applyMiddleware 接收的参数是可变参数</span>
<span class="token comment">// 所以 middleware 是数组</span>
<span class="token comment">// 作用：将所有中间件组成一个数组，依次执行</span>
<span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
  <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">,</span>
  initial_state<span class="token punctuation">,</span> <span class="token comment">// 设置 state 的初始值</span>
  <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middleware<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="视图与数据-上"><a href="#视图与数据-上" class="header-anchor">#</a> 视图与数据(上)</h2> <p><code>src/index.js</code> 主要实现了 dva 的 view 层，同时传递了一些初始化数据到 dva-core 所实现的 model 层。当然，还提供了一些 dva 中常用的方法函数：</p> <ul><li><code>dynamic</code> 动态加载(2.0 以后官方提供 1.x 自己手动实现吧)</li> <li><code>fetch</code> 请求方法(其实 dva 只是做了一把搬运工)</li> <li><code>saga</code>(数据层处理异步的方法)。</li></ul> <p>这么看 dva 真的是很薄的一层封装。</p> <p>而 dva-core 主要解决了 model 的问题，包括 state 管理、数据的异步加载、订阅-发布模式的实现，可以作为数据层在别处使用(看 2.0 更新也确实是作者的意图)。使用的状体啊管理库还是 redux，异步加载的解决方案是 saga。当然，一切也都写在 index.js 和 package.json 里。</p> <h2 id="视图与数据-下"><a href="#视图与数据-下" class="header-anchor">#</a> 视图与数据(下)</h2> <p>处理 React 的 model 层问题有很多种办法，比如状态管理就不一定要用 Redux，也可以使用 Mobx(写法会更有 MVX 框架的感觉)；异步数据流也未必使用 redux-saga，redux-thunk 或者 redux-promise 的解决方式也可以(不过目前看来 saga 是相对更优雅的)。</p> <p>放两篇个人感觉比较全面的技术文档：</p> <ul><li>阮一峰前辈的 <a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_one_basic_usages.html" target="_blank" rel="noopener noreferrer">redux 三部曲<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li> <li>redux-saga 的<a href="http://leonshi.com/redux-saga-in-chinese/docs/api/index.html" target="_blank" rel="noopener noreferrer">中文文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <p>以及两者的 github：</p> <ul><li><a href="https://github.com/reactjs/redux" target="_blank" rel="noopener noreferrer">redux<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/redux-saga/redux-saga" target="_blank" rel="noopener noreferrer">redux-saga<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>然后继续深扒 <code>dva-core</code>，还是先从 <code>package.json</code> 扒起。</p> <h2 id="package-json"><a href="#package-json" class="header-anchor">#</a> package.json</h2> <p><code>dva-core</code> 的 <code>package.json</code> 中依赖包如下：</p> <div class="language-json extra-class"><pre class="language-json"><code>    <span class="token property">&quot;babel-runtime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 一个编译后文件引用的公共库，可以有效减少编译后的文件体积</span>
    <span class="token property">&quot;flatten&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.0.2&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 一个将多个数组值合并成一个数组的库</span>
    <span class="token property">&quot;global&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.3.2&quot;</span><span class="token punctuation">,</span><span class="token comment">// 用于提供全局函数比如 document 的引用</span>
    <span class="token property">&quot;invariant&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.2.1&quot;</span><span class="token punctuation">,</span><span class="token comment">// 一个有趣的断言库</span>
    <span class="token property">&quot;is-plain-object&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.3&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 判断是否是一个对象</span>
    <span class="token property">&quot;redux&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.1&quot;</span><span class="token punctuation">,</span> <span class="token comment">// redux ，管理 react 状态的库</span>
    <span class="token property">&quot;redux-saga&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^0.15.4&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 处理异步数据流</span>
    <span class="token property">&quot;warning&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span> <span class="token comment">// 同样是个断言库，不过输出的是警告</span>
</code></pre></div><p>当然因为打包还是用的 <code>ruban</code>，script 里没有什么太多有用的东西。继续依循惯例，去翻 <code>src/index.js</code>。</p> <h2 id="src-index-js-3"><a href="#src-index-js-3" class="header-anchor">#</a> <code>src/index.js</code></h2> <p><code>src/index</code> 的源码在<a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/index.js" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>在 <code>dva</code> 的 <code>src/index.js</code> 里，通过传递 2 个变量 <code>opts</code> 和 <code>createOpts</code> 并调用 <code>core.create</code>，<code>dva</code> 创建了一个 app 对象。其中 <code>opts</code> 是使用者添加的控制选项，<code>createOpts</code> 则是初始化了 reducer 与 redux 的中间件。</p> <p><code>dva-core</code> 的 <code>src/index.js</code> 里便是这个 app 对象的具体创建过程以及包含的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">hooksAndOpts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> createOpts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    initialReducer<span class="token punctuation">,</span>
    setupApp <span class="token operator">=</span> noop<span class="token punctuation">,</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> createOpts<span class="token punctuation">;</span>

  <span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Plugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  plugin<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">filterHooks</span><span class="token punctuation">(</span>hooksAndOpts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token punctuation">{</span>
    _models<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token function">prefixNamespace</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>dvaModel <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    _store<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    _plugin<span class="token operator">:</span> plugin<span class="token punctuation">,</span>
    use<span class="token operator">:</span> plugin<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">,</span>
    model<span class="token punctuation">,</span>
    start<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> app<span class="token punctuation">;</span>
  	<span class="token comment">// .... 方法的实现</span>
	
	<span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// model 方法</span>
	<span class="token punctuation">}</span>
	
	functoin <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// Start 方法</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>我最开始很不习惯 JavaScript 就是因为 JavaScript 还是一个函数向的编程语言，也就是函数里可以定义函数，返回值也可以是函数，class 最后也是被解释成函数。在 dva-core 里创建了 app 对象，但是把 model 和 start 的定义放在了后面。一开始对这种简写没看懂，后来熟悉了以后发现确实好理解。一眼就可以看到 app 所包含的方法，如果需要研究具体方法的话才需要向后看。</p></blockquote> <p><a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/Plugin.js" target="_blank" rel="noopener noreferrer">Plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是作者设置的一堆<strong>钩子</strong>性监听函数——即是在符合某些条件的情况下下(dva 作者)进行手动调用。这样使用者只要按照作者设定过的关键词传递回调函数，在这些条件下便会自动触发。</p> <blockquote><p>有趣的是，我最初理解<strong>钩子</strong>的概念是在 Angular 里。为了能像 React 一样优雅的控制组件的生命周期，Angular 设置了一堆接口(因为使用的是 ts，所以 Angular 里有类和接口的区分)。只要组件实现(implements)对应的接口————或者称生命周期钩子，在对应的条件下就会运行接口的方法。</p></blockquote> <h4 id="plugin-与-plugin-use"><a href="#plugin-与-plugin-use" class="header-anchor">#</a> Plugin 与 plugin.use</h4> <p>Plugin 与 plugin.use 都有使用数组的 reduce 方法的行为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'onError'</span><span class="token punctuation">,</span>
  <span class="token string">'onStateChange'</span><span class="token punctuation">,</span>
  <span class="token string">'onAction'</span><span class="token punctuation">,</span>
  <span class="token string">'onHmr'</span><span class="token punctuation">,</span>
  <span class="token string">'onReducer'</span><span class="token punctuation">,</span>
  <span class="token string">'onEffect'</span><span class="token punctuation">,</span>
  <span class="token string">'extraReducers'</span><span class="token punctuation">,</span>
  <span class="token string">'extraEnhancers'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">filterHooks</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果对象的 key 在 hooks 数组中</span>
  <span class="token comment">// 为 memo 对象添加新的 key，值为 obj 对应 key 的值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> hooks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
		等同于
		
		this.hooks = {
			onError: [],
			onStateChange:[],
			....
			extraEnhancers: []
		}
	*/</span>
  <span class="token punctuation">}</span>

  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'plugin.use: plugin should be plain object'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> plugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>plugin<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">invariant</span><span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin.use: unknown plugin property: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'extraEnhancers'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> plugin<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 其他方法</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>构造器中的 <code>reduce</code> 初始化了一个以 <code>hooks</code> 数组所有元素为 key，值为空数组的对象，并赋给了 class 的私有变量 <code>this.hooks</code>。</p></li> <li><p><code>filterHooks</code> 通过 <code>reduce</code> 过滤了 <code>hooks</code> 数组以外的钩子。</p></li> <li><p><code>use</code> 中使用 <code>hasOwnProperty</code> 判断 <code>key</code> 是 <code>plugin</code> 的自身属性还是继承属性，使用原型链调用而不是 <code>plugin.hasOwnProperty()</code> 是防止使用者故意捣乱在 <code>plugin</code> 自己写一个 <code>hasOwnProperty = () =&gt; false // 这样无论如何调用 plugin.hasOwnProperty() 返回值都是 false</code>。</p></li> <li><p><code>use</code> 中使用 <code>reduce</code> 为 <code>this.hooks</code> 添加了 <code>plugin[key]</code> 。</p></li></ul> <h2 id="model-方法"><a href="#model-方法" class="header-anchor">#</a> model 方法</h2> <p><code>model</code> 是 app 添加 model 的方法，在 <strong>dva 项目</strong> 的 index.js 是这么用的。</p> <blockquote><p>app.model(require('./models/example'));</p></blockquote> <p>在 <code>dva</code> 中没对 model 做任何处理，所以 <code>dva-core</code> 中的 model 就是 <strong>dva 项目</strong> 里调用的 model。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkModel</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">prefixNamespace</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</code></pre></div><ul><li><p><code>checkModel</code> 主要是用 <code>invariant</code> 对传入的 model 进行了合法性检查。</p></li> <li><p><code>prefixNamespace</code> 又使用 reduce 对每一个 model 做处理，为 model 的 reducers 和 effects 中的方法添加了 <code>${namespace}/</code> 的前缀。</p></li></ul> <blockquote><p>Ever wonder why we dispatch the action like this in dva ? <code>dispatch({type: 'example/loadDashboard'</code></p></blockquote> <h2 id="start-方法"><a href="#start-方法" class="header-anchor">#</a> start 方法</h2> <p><code>start</code> 方法是 <code>dva-core</code> 的核心，在 <code>start</code> 方法里，dva 完成了 <strong><code>store</code> 初始化</strong> 以及 <strong><code>redux-saga</code> 的调用</strong>。比起 <code>dva</code> 的 <code>start</code>，它引入了更多的调用方式。</p> <p>一步一步分析：</p> <h3 id="onerror"><a href="#onerror" class="header-anchor">#</a> <code>onError</code></h3> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token function-variable function">onError</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> err <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err<span class="token punctuation">.</span><span class="token function-variable function">preventDefault</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          err<span class="token punctuation">.</span>_dontReject <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">'onError'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>dispatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这是一个全局错误处理，返回了一个接收错误并处理的函数，并以 <code>err</code> 和 <code>app._store.dispatch</code> 为参数执行调用。</p> <p>看一下 <code>plugin.apply</code> 的实现：</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> defaultHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">;</span>
	<span class="token comment">/* 通过 validApplyHooks 进行过滤， apply 方法只能应用在全局报错或者热更替上 */</span> 
    <span class="token keyword">const</span>  validApplyHooks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'onError'</span><span class="token punctuation">,</span> <span class="token string">'onHmr'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>validApplyHooks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">plugin.apply: hook </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> cannot be applied</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* 从钩子中拿出挂载的回调函数 ，挂载动作见 use 部分*/</span>
    <span class="token keyword">const</span> fns <span class="token operator">=</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// 如果有回调执行回调</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fns<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">fn</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 没有回调直接抛出错误</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">defaultHandler</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token comment">/*
		这里 defaultHandler 为 (err) =&gt; {
          throw new Error(err.stack || err);
        }
		*/</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="sagamiddleware"><a href="#sagamiddleware" class="header-anchor">#</a> <code>sagaMiddleware</code></h3> <p>下一行代码是：</p> <blockquote><p><code>const sagaMiddleware = createSagaMiddleware();</code></p></blockquote> <p>和 <code>redux-sagas</code> 的入门教程有点差异，因为正统的教程上添加 sagas 中间件的方法是： <code>createSagaMiddleware(...sagas)</code></p> <blockquote><p>sagas 为含有 saga 方法的 generator 函数数组。</p></blockquote> <p>但是 api 里确实还提到，还有一~<s>招从天而降的掌法</s>~种动态调用的方式：</p> <blockquote><p><code>const task = sagaMiddleware.run(dynamicSaga)</code></p></blockquote> <p>于是：</p> <div class="language-js extra-class"><pre class="language-js"><code>	  <span class="token keyword">const</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token comment">// ...</span>
      <span class="token keyword">const</span> sagas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> reducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">...</span>initialReducer
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	reducers<span class="token punctuation">[</span>m<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getReducer</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>reducers<span class="token punctuation">,</span> m<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">)</span> sagas<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">_getSaga</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> m<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onEffect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ....</span>

      store<span class="token punctuation">.</span>runSaga <span class="token operator">=</span> sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">;</span>
      <span class="token comment">// Run sagas</span>
      sagas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="sagas"><a href="#sagas" class="header-anchor">#</a> <code>sagas</code></h3> <p>那么 sagas 是什么呢？</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> <span class="token punctuation">{</span>
      middleware<span class="token operator">:</span> promiseMiddleware<span class="token punctuation">,</span>
      resolve<span class="token punctuation">,</span>
      reject<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createPromiseMiddleware</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span>_getSaga <span class="token operator">=</span> <span class="token function">getSaga</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> sagas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> m <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">)</span> sagas<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token function">_getSaga</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> m<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onEffect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>显然，sagas 是一个数组，里面的元素是用 <code>app._getSaga</code> 处理后的返回结果，而 <code>app._getSaga</code> 又和上面 createPromiseMiddleware 代理 app 后返回的对象有很大关系。</p> <h4 id="createpromisemiddleware"><a href="#createpromisemiddleware" class="header-anchor">#</a> <code>createPromiseMiddleware</code></h4> <p>createPromiseMiddleware 的代码<a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/createPromiseMiddleware.js" target="_blank" rel="noopener noreferrer">在此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>如果看着觉得眼熟，那肯定不是因为看过 redux-promise 源码的缘故，:-p。</p> <h5 id="middleware"><a href="#middleware" class="header-anchor">#</a> <code>middleware</code></h5> <p><code>middleware</code> 是一个 redux 的中间件，即在不影响 redux 本身功能的情况下为其添加了新特性的代码。redux 的中间件通过拦截 action 来实现其作用的。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEffect</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token comment">// .... resolve ,reject</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
    <span class="token keyword">function</span> <span class="token function">isEffect</span><span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// dva 里 action 的 type 有固定格式： model.namespace/model.effects</span>
		<span class="token comment">// const [namespace] = type.split(NAMESPACE_SEP); 是 es6 解构的写法</span>
		<span class="token comment">// 等同于 const namespace = type.split(NAMESPACE_SEP)[0];</span>
		<span class="token comment">// NAMESPACE_SEP 的值是 `/`</span>
    	<span class="token keyword">const</span> <span class="token punctuation">[</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">NAMESPACE_SEP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 根据 namespace 过滤出对应的 model</span>
    	<span class="token keyword">const</span> model <span class="token operator">=</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>namespace <span class="token operator">===</span> namespace<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果 model 存在并且 model.effects[type] 也存在，那必然是 effects</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    		<span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>effects <span class="token operator">&amp;&amp;</span> model<span class="token punctuation">.</span>effects<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    		<span class="token punctuation">}</span>
    	<span class="token punctuation">}</span>

    	<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>const middleware = ({dispatch}) =&gt; next =&gt; (action) =&gt; {... return next(action)} 基本上是一个标准的中间件写法。在 return next(action) 之前可以对 action 做各种各样的操作。因为此中间件没用到 dispatch 方法，所以省略了。</p></blockquote> <p>本段代码的意思是，如果 dispatch 的 action 指向的是 model 里的 effects，那么返回一个 Promise 对象。此 Promise 的对象的解决( resolve )或者驳回方法 ( reject ) 放在 map 对象中。如果是非 effects (那就是 action 了)，放行。</p> <p>换句话说，middleware 拦截了指向 effects 的 action。</p> <h5 id="神奇的-bind"><a href="#神奇的-bind" class="header-anchor">#</a> 神奇的 bind</h5> <p>bind 的作用是绑定新的对象，生成新函数是大家都知道概念。但是 bind 也可以提前设定好函数的某些参数生成新函数，等到最后一个参数确定时直接调用。</p> <blockquote><p>JavaScript 的参数是怎么被调用的？<a href="https://juejin.im/post/598d0b7ff265da3e1727c491" target="_blank" rel="noopener noreferrer">JavaScript 专题之函数柯里化<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。作者：<a href="https://juejin.im/user/58e4b9b261ff4b006b3227f4" target="_blank" rel="noopener noreferrer">冴羽<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。文章来源：<a href="https://juejin.im/timeline" target="_blank" rel="noopener noreferrer">掘金<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>这段代码恰好就是 bind 的一种实践方式。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          resolve<span class="token operator">:</span> <span class="token function">wrapped</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">,</span>
          reject<span class="token operator">:</span> <span class="token function">wrapped</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ....</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">function</span> <span class="token function">wrapped</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">delete</span> map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">fn</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      map<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
   <span class="token keyword">return</span> <span class="token punctuation">{</span>
    middleware<span class="token punctuation">,</span>
    resolve<span class="token punctuation">,</span>
    reject<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>分析这段代码，dva 是这样做的：</p> <ol><li>通过 <code>wrapped.bind(null, type, resolve)</code> 产生了一个新函数，并且赋值给匿名对象的 resolve 属性(reject 同理)。</li></ol> <blockquote><p>1.1 wrap 接收三个参数，通过 bind 已经设定好了两个。<code>wrapped.bind(null, type, resolve)</code> 等同于 <code>wrap(type, resolve, xxx)</code>（<strong>此处  <code>resolve</code> 是 Promise 对象中的</strong>）。</p></blockquote> <blockquote><p>1.2 通过 bind 赋给匿名对象的 resolve 属性后，匿名对象.resolve(xxxx) 等同于 wrap(type, resolve, xxx)，即 reslove(xxx)。</p></blockquote> <ol start="2"><li><p>使用 type 在 map 对象中保存此匿名对象，而 type 是 action 的 type，即 namespace/effects 的形式，方便之后进行调用。</p></li> <li><p>return 出的 resolve 接收 type 和 args 两个参数。type 用来在 map 中寻找 1 里的匿名函数，args 用来像 1.2 里那样执行。</p></li></ol> <blockquote><p>这样做的作用是：分离了 promise 与 promise 的执行。在函数的作用域外依然可以访问到函数的内部变量，换言之：闭包。</p></blockquote> <h4 id="getsaga"><a href="#getsaga" class="header-anchor">#</a> <code>getSaga</code></h4> <p>导出的 <code>resolve</code> 与 <code>reject</code> 方法，通过 bind 先设置进了 <code>getSaga</code> (同时也赋给了 <code>app._getSaga</code>)，sagas 最终也将 <code>getSaga</code> 的返回值放入了数组。</p> <p><a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/src/getSaga.js" target="_blank" rel="noopener noreferrer">getSaga 源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">getSaga</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> effects<span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> effects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>effects<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token function">getWatcher</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> key<span class="token punctuation">,</span> effects<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 将 watcher 分离到另一个线程去执行</span>
        <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 同时 fork 了一个线程，用于在 model 卸载后取消正在进行中的 task</span>
		<span class="token comment">// `${model.namespace}/@@CANCEL_EFFECTS` 的发出动作在 index.js 的 start 方法中，unmodel 方法里。</span>
        <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>model<span class="token punctuation">.</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/@@CANCEL_EFFECTS</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到，<code>getSaga</code> 最终返回了一个 <a href="http://www.ruanyifeng.com/blog/2015/04/generator.html" target="_blank" rel="noopener noreferrer">generator 函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>在该函数遍历了 <strong>model 中 effects 属性</strong> 的所有方法（注：同样是 generator 函数）。结合 <code>index.js</code> 里的 <code>for (const m of app._models)</code>，该遍历针对所有的 model。</p> <p>对于每一个 effect，getSaga 生成了一个 watcher ，并使用 saga 函数的 <strong>fork</strong> 将该函数切分到另一个单独的线程中去（生成了一个 task 对象）。同时为了方便对该线程进行控制，在此 fork 了一个 generator 函数。在该函数中拦截了取消 effect 的 action（事实上，应该是卸载effect 所在 model 的 action），一旦监听到则立刻取消分出去的 task 线程。</p> <h5 id="getwatcher"><a href="#getwatcher" class="header-anchor">#</a> getWatcher</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getWatcher</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> key<span class="token punctuation">,</span> _effect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> onError<span class="token punctuation">,</span> onEffect</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> effect <span class="token operator">=</span> _effect<span class="token punctuation">;</span>
  <span class="token keyword">let</span> type <span class="token operator">=</span> <span class="token string">'takeEvery'</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ms<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// effect 是数组而不是函数的情况下暂不考虑</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">sagaWithCatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// .... sagaWithCatch 的逻辑</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> sagaWithOnEffect <span class="token operator">=</span> <span class="token function">applyOnEffect</span><span class="token punctuation">(</span>onEffect<span class="token punctuation">,</span> sagaWithCatch<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'watcher'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> sagaWithCatch<span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'takeLatest'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'throttle'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">throttle</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createEffects</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// createEffects(model) 的逻辑</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">applyOnEffect</span><span class="token punctuation">(</span><span class="token parameter">fns<span class="token punctuation">,</span> effect<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> fns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    effect <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>effect<span class="token punctuation">,</span> sagaEffects<span class="token punctuation">,</span> model<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>先不考虑 effect 的属性是数组而不是方法的情况。</p> <p><code>getWatcher</code> 接收六个参数：</p> <ul><li><code>resolve/reject</code>: 中间件 <code>middleware</code> 的 res 和 rej 方法。</li> <li><code>key</code>:经过 prefixNamespace 转义后的 effect 方法名，namespace/effect（也是调用 action 时的 type）。
-<code>_effect</code>:effects 中 key 属性所指向的 generator 函数。</li> <li><code>model</code>： model</li> <li><code>onError</code>： 之前定义过的捕获全局错误的方法</li> <li><code>onEffect</code>：plugin.use 中传入的在触发 effect 时执行的回调函数（钩子函数）</li></ul> <p><code>applyOnEffect</code> 对 effect 进行了动态代理，在保证 effect （即 <code>_effect</code>）正常调用的情况下，为期添加了 fns 的回调函数数组(即 <code>onEffect</code>)。使得在 effect 执行时， <code>onEffect</code> 内的每一个回调函数都可以被触发。</p> <p>因为没有经过 effects 的属性是数组的情况，所以 <code>type</code> 的值是 <code>takeEvery</code>，也就是监听每一个发出的 action ，即 <code>getWatcher</code> 的返回值最终走的是 switch 的 default 选项:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> sagaWithOnEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
	  
</code></pre></div><p>换句话说，每次发出指向 effects 的函数都会调用 <code>sagaWithOnEffect</code>。</p> <p>根据 <code>const sagaWithOnEffect = applyOnEffect(onEffect, sagaWithCatch, model, key);</code> 的执行情况，如果 onEffect 的插件为空的情况下，<code>sagaWithOnEffect</code> 的值为 <code>sagaWithCatch</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">function</span> <span class="token operator">*</span><span class="token function">sagaWithCatch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NAMESPACE_SEP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@@start</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">createEffects</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> sagaEffects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NAMESPACE_SEP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">@@end</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>e<span class="token punctuation">.</span>_dontReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

</code></pre></div><p>在 <code>sagaWithOnEffect</code> 函数中，sagas 使用传入的参数(也就是 action)执行了对应的 model 中 对应的 effect 方法，同时将返回值使用之前保存在 map 里的 resolve 返回了其返回值。同时在执行 effect 方法的时候，将 saga 本身的所有方法(put、call、fork 等等)作为第二个参数，使用 <code>concat</code> 拼接在 action 的后面。在执行 effect 方法前，又发出了 start 和 end 两个 action，方便 onEffect 的插件进行拦截和调用。</p> <p>因此，对于 <code>if (m.effects) sagas.push(app._getSaga(m.effects, m, onError, plugin.get('onEffect')));</code>。</p> <ol><li>dva 通过 <code>app._getSaga(m.effects, m, onError, plugin.get('onEffect'))</code> 返回了一个 genenrator 函数。</li> <li>在 genenrator 函数中手动 fork 出一个 watcher 函数的监听线程(当然也 fork 了取消线程的功能)。</li> <li>该函数(在普通状态下)是一个 takeEvery 的阻塞是线程，接收 2 个参数。第一个参数为监听的 action，第二个参数为监听到 action 后的回调函数。</li> <li>(普通状态下)的回调函数，就是手动调用了 model 里 effects 中对应属性的函数。在此之前之后发出了 <code>start</code> 和 <code>end</code> 的 action，同时用之前 promise 中间件保存在 map 中的 resolve 方法返回了值。</li> <li>最后使用 sagas.forEach(sagaMiddleware.run) 启动了 watcher 的监听。</li></ol> <h3 id="store"><a href="#store" class="header-anchor">#</a> store</h3> <p>现在已经有了针对异步数据流的解决办法，那么该创建 store 了。</p> <p>正常情况的 redux 的 createStore 接收三个参数 reducer, initState,applyMiddleware(middlewares)。</p> <p>不过 dva 提供了自己的 <code>createStore</code> 方法，用来组织一系列自己创建的参数。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Create store</span>
    <span class="token keyword">const</span> store <span class="token operator">=</span> app<span class="token punctuation">.</span>_store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// eslint-disable-line</span>
      reducers<span class="token operator">:</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      initialState<span class="token operator">:</span> hooksAndOpts<span class="token punctuation">.</span>initialState <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      plugin<span class="token punctuation">,</span>
      createOpts<span class="token punctuation">,</span>
      sagaMiddleware<span class="token punctuation">,</span>
      promiseMiddleware<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="createreducer"><a href="#createreducer" class="header-anchor">#</a> createReducer</h4> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">function</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reducerEnhancer</span><span class="token punctuation">(</span><span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token operator">...</span>reducers<span class="token punctuation">,</span>
        <span class="token operator">...</span>extraReducers<span class="token punctuation">,</span>
        <span class="token operator">...</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_store <span class="token operator">?</span> app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>asyncReducers <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><code>createReducer</code> 实际上是用 plugin 里的 onReducer (如果有)扩展了 reducer 功能，对于 <code>const reducerEnhancer = plugin.get('onReducer');</code>，plugin 里的相关代码为：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getOnReducer</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> reducerEnhancer <span class="token keyword">of</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reducer <span class="token operator">=</span> <span class="token function">reducerEnhancer</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> reducer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>如果有 onReducer 的插件，那么用 reducer 的插件扩展 reducer；否则直接返回 reducer。</p></blockquote> <p>combineReducers 中：</p> <ul><li>第一个 <code>...reducers</code> 是从 dva 里传入的 historyReducer，以及通过 <code>reducers[m.namespace] = getReducer(m.reducers, m.state);</code> 剥离出的 model 中的 reducer</li> <li>第二个参数为手动在 plugin 里添加的 extraReducers；</li> <li>第三个参数为异步 reducer，主要是用于在 dva 运行以后动态加载 model 里的 reducer。</li></ul> <h4 id="createstore"><a href="#createstore" class="header-anchor">#</a> createStore</h4> <p>现在我们有了一个 combine 过的 reducer，有了 core 中创建的 sagaMiddleware 和 promiseMiddleware，还有了从 dva 中传入的 createOpts，现在可以正式创建 store 了。</p> <blockquote><p>从 dva 中传入的 createOpts 为</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token function">routerMiddleware</span><span class="token punctuation">(</span>history<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>middlewares<span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><blockquote><p>用与把 redux-router 的中间件排在中间件的第一个。</p></blockquote> <p>虽然看起来很长，但是对于大多数普通用户来说，在未开启 redux 的调试插件，未传入额外的 onAction 以及 extraEnhancers 的情况下，上面的代码等价于:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">,</span> compose <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> flatten <span class="token keyword">from</span> <span class="token string">'flatten'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> invariant <span class="token keyword">from</span> <span class="token string">'invariant'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> window <span class="token keyword">from</span> <span class="token string">'global/window'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> returnSelf<span class="token punctuation">,</span> isArray <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  reducers<span class="token punctuation">,</span>
  initialState<span class="token punctuation">,</span>
  plugin<span class="token punctuation">,</span>
  sagaMiddleware<span class="token punctuation">,</span>
  promiseMiddleware<span class="token punctuation">,</span>
  createOpts<span class="token operator">:</span> <span class="token punctuation">{</span>
    setupMiddlewares <span class="token operator">=</span> returnSelf<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> middlewares <span class="token operator">=</span> <span class="token function">setupMiddlewares</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    sagaMiddleware<span class="token punctuation">,</span>
    promiseMiddleware
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> enhancers <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token function">applyMiddleware</span><span class="token punctuation">(</span><span class="token operator">...</span>middlewares<span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducers<span class="token punctuation">,</span> initialState<span class="token punctuation">,</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token operator">...</span>enhancers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 对于 redux 中 的 compose 函数，在数组长度为 1  的情况下返回第一个元素。</span>
  <span class="token comment">// compose(...enhancers) 等同于 applyMiddleware(...middlewares)</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="订阅"><a href="#订阅" class="header-anchor">#</a> 订阅</h3> <p>现在 dva 已经创建了 store，有了异步数据流加载方案，并且又做了一些其他的事情：</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Extend store</span>
    store<span class="token punctuation">.</span>runSaga <span class="token operator">=</span> sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">;</span>
    store<span class="token punctuation">.</span>asyncReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Execute listeners when state is changed</span>
    <span class="token keyword">const</span> listeners <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'onStateChange'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">listener</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Run sagas</span>
    sagas<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">.</span>run<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>手动运行 getSaga 里返回的 watcer 函数。</li> <li>判断如果有 onStateChange 的 plugin 也手动运行一下。</li></ul> <p>model 里的 state、effect、reducer 已经实现了，就缺最后的订阅 subscription 部分。</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token comment">// Setup app</span>
    <span class="token function">setupApp</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Run subscriptions</span>
    <span class="token keyword">const</span> unlisteners <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unlisteners<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">runSubscription</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>subscriptions<span class="token punctuation">,</span> model<span class="token punctuation">,</span> app<span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>setupApp(app) 是从 dva 里传过来的，主要是使用 patchHistory 函数代理 history.linsten，即强化了 redux 和 router 的联系，是的路径变化可以引起 state 的变化，进而听过监听 state 的变化来触发回调。</p> <blockquote><p>这也是 core 中唯一使用 this 的地方，逼得 dva 中必须使用 oldStart.call(app) 来进行调用。</p></blockquote> <h4 id="runsubscription"><a href="#runsubscription" class="header-anchor">#</a> runSubscription</h4> <p>这是 runSubscription 的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token parameter">subs<span class="token punctuation">,</span> model<span class="token punctuation">,</span> app<span class="token punctuation">,</span> onError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> funcs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> nonFuncs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> subs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>subs<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sub <span class="token operator">=</span> subs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> unlistener <span class="token operator">=</span> <span class="token function">sub</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        dispatch<span class="token operator">:</span> <span class="token function">prefixedDispatch</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>_store<span class="token punctuation">.</span>dispatch<span class="token punctuation">,</span> model<span class="token punctuation">)</span><span class="token punctuation">,</span>
        history<span class="token operator">:</span> app<span class="token punctuation">.</span>_history<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>unlistener<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        funcs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>unlistener<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        nonFuncs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> funcs<span class="token punctuation">,</span> nonFuncs <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>第一个参数为 model 中的 subscription 对象。</li> <li>第二个参数为对应的 model</li> <li>第三个参数为 core 里创建的 app</li> <li>第四个参数为全局异常捕获的 onError</li></ul> <ol><li><p><code>Object.prototype.hasOwnProperty.call(subs, key)</code>
还是使用原型方法判断 key 是不是 subs 的自有属性。</p></li> <li><p>如果是自由属性，那么拿到属性对应的值(是一个 function)</p></li> <li><p>调用该 function，传入 dispatch 和 history 属性。history 就是经过 redux-router 强化过的 history，而 dispatch，也就是 <code>prefixedDispatch(app._store.dispatch, model)</code></p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">prefixedDispatch</span><span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// 断言检测</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token operator">...</span>action<span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token function">prefixType</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> model<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>实际上是用将 action 里的 type 添加了 <code>${model.namespance}/</code> 的前缀。</p> <p>自此，model 中的四大组件全部完毕，完成了 dva 的数据层处理。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xukhxukh/websiteTest/edit/master/docs/guide/source-code-explore.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2/17/2020, 5:26:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/websiteTest/guide/develop-complex-spa.html" class="prev">
        使用 Dva 开发复杂 SPA
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/websiteTest/assets/js/app.ecceaa25.js" defer></script><script src="/websiteTest/assets/js/2.851851d3.js" defer></script><script src="/websiteTest/assets/js/18.1ffc641a.js" defer></script>
  </body>
</html>
